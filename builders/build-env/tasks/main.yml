- uri:
    url:    "{{ recurse_url }}?recurse=true"
    method: GET
    status: 200
  register: consul_data
  failed_when: consul_data.status not in [200,404]

- lineinfile:
    path:   "{{ build_env }}"
    create: yes
    regexp: '^export {{ item.Key|basename|upper }}='
    line:   'export {{ item.Key|basename|upper }}="{{ item.Value|b64decode }}"'
  with_items: 
    - "{{ consul_data.json }}"
  loop_control: 
    label: "{{ item.Key|basename|upper }}"