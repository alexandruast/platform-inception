- name: "service archive downloaded"
  get_url:
    url:  "https://releases.hashicorp.com/{{service_name}}/{{service_version}}/{{service_name}}_{{service_version}}_linux_amd64.zip"
    dest: "{{artifacts_dir}}/{{service_name}}_{{service_version}}_linux_amd64.zip"
    force: "{{download_force|default(false)}}"
  become: true

- name: "service binaries installed"
  unarchive:
    src:  "{{artifacts_dir}}/{{service_name}}_{{service_version}}_linux_amd64.zip"
    dest: /usr/local/bin/
    mode: +x
    remote_src: yes
  become: true

- block:
  - name: "service group present"
    group:
      name: "{{service_group}}"
    become: true

  - name: "service user present"
    user:
      name: "{{service_user}}"
      group: "{{service_group}}"
    become: true

  - name: "service data directory created"
    file:
      path: "{{service_data_dir}}"
      state: directory
      mode: 0750
      owner:  "{{service_user}}"
      group:  "{{service_group}}"
    become: true

  - name: "service conf directory created"
    file:
      path: "{{service_conf_dir}}"
      state: directory
      mode: 0755
    become: true

  - name: "systemd service config updated"
    template:
      src: "{{service_init_conf}}"
      dest: "/etc/systemd/system/{{service_name}}.service"
      mode: 0755
    become: true  
    register: systemd_config

  - name: "systemd daemon reload"
    systemd: daemon_reload=yes
    changed_when: true
    become: true
    when: systemd_config is changed

  - name: "service config file updated"
    template:
      src: "{{service_name}}.hcl.j2"
      dest: "{{service_conf_dir}}/service.hcl"
      mode: 0644
    become: true
    register: service_config

  - name: "service enabled"
    systemd:
      name: "{{service_name}}"
      enabled: yes
    become: true
    
  - name: "service started"
    systemd:
      name: "{{service_name}}"
      state: started
    become: true
    register: service_started
    
  - name: "restart service"
    systemd:
      name: "{{service_name}}"
      state: restarted
    become: true
    when: (systemd_config is changed or service_config is changed) and not service_started is changed

  when: service_mode|default(false)
